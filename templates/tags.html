<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Tags - Book Vault</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Manage Tags</h1>
        <div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary me-2">Back to Books</a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTagModal">Create New Tag</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">All Tags</h5>
                </div>
                <div class="card-body">
                    {% if tags %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Tag</th>
                                    <th>Color</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tag in tags %}
                                <tr>
                                    <td>
                                        <span class="badge" style="background-color: {{ tag.color }}; color: white;">
                                            {{ tag.name }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="color-preview me-2" style="width: 20px; height: 20px; background-color: {{ tag.color }}; border-radius: 3px; border: 1px solid #ddd;"></div>
                                            <code>{{ tag.color }}</code>
                                        </div>
                                    </td>
                                    <td>{{ tag.created_at.strftime('%Y-%m-%d') if tag.created_at else 'N/A' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1 edit-tag-btn" 
                                                data-tag-id="{{ tag.id }}" 
                                                data-tag-name="{{ tag.name }}" 
                                                data-tag-color="{{ tag.color }}">
                                            Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-tag-btn" 
                                            onclick="deleteTag({{ tag.id }}, '{{ tag.name }}')">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No tags created yet. Create your first tag to start organizing your books!</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Tag Usage Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">üìö <strong>Genres:</strong> Fiction, Non-fiction, Mystery, Romance</li>
                        <li class="mb-2">‚≠ê <strong>Ratings:</strong> Favorites, Must-read, Disappointing</li>
                        <li class="mb-2">üìñ <strong>Format:</strong> Hardcover, Paperback, Audiobook</li>
                        <li class="mb-2">üéØ <strong>Purpose:</strong> Research, Entertainment, Learning</li>
                        <li class="mb-2">üìÖ <strong>Time:</strong> Quick-read, Long-read, Weekend</li>
                        <li class="mb-2">üë• <strong>Source:</strong> Book-club, Recommendation, Award-winner</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Tag Modal -->
<div class="modal fade" id="createTagModal" tabindex="-1" aria-labelledby="createTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTagModalLabel">Create New Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createTagForm">
                    <div class="mb-3">
                        <label for="tagName" class="form-label">Tag Name</label>
                        <input type="text" class="form-control" id="tagName" required>
                    </div>
                    <div class="mb-3">
                        <label for="tagColor" class="form-label">Tag Color</label>
                        <div class="d-flex align-items-center">
                            <input type="color" class="form-control form-control-color me-2" id="tagColor" value="#007bff" style="width: 60px;">
                            <input type="text" class="form-control" id="tagColorText" value="#007bff" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Preview</label>
                        <div>
                            <span class="badge" id="tagPreview" style="background-color: #007bff; color: white;">
                                Sample Tag
                            </span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTag()">Create Tag</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Tag Modal -->
<div class="modal fade" id="editTagModal" tabindex="-1" aria-labelledby="editTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTagModalLabel">Edit Tag</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTagForm">
                    <input type="hidden" id="editTagId">
                    <div class="mb-3">
                        <label for="editTagName" class="form-label">Tag Name</label>
                        <input type="text" class="form-control" id="editTagName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTagColor" class="form-label">Tag Color</label>
                        <div class="d-flex align-items-center">
                            <input type="color" class="form-control form-control-color me-2" id="editTagColor" style="width: 60px;">
                            <input type="text" class="form-control" id="editTagColorText" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Preview</label>
                        <div>
                            <span class="badge" id="editTagPreview" style="color: white;">
                                Sample Tag
                            </span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateTag()">Update Tag</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Initialize modals
    const createTagModal = new bootstrap.Modal(document.getElementById('createTagModal'));
    const editTagModal = new bootstrap.Modal(document.getElementById('editTagModal'));

    // Color picker event listeners for create modal
    document.getElementById('tagColor').addEventListener('input', function() {
        const color = this.value;
        document.getElementById('tagColorText').value = color;
        document.getElementById('tagPreview').style.backgroundColor = color;
    });

    document.getElementById('tagName').addEventListener('input', function() {
        const name = this.value || 'Sample Tag';
        document.getElementById('tagPreview').textContent = name;
    });

    // Color picker event listeners for edit modal
    document.getElementById('editTagColor').addEventListener('input', function() {
        const color = this.value;
        document.getElementById('editTagColorText').value = color;
        document.getElementById('editTagPreview').style.backgroundColor = color;
    });

    document.getElementById('editTagName').addEventListener('input', function() {
        const name = this.value || 'Sample Tag';
        document.getElementById('editTagPreview').textContent = name;
    });

    async function createTag() {
        const name = document.getElementById('tagName').value.trim();
        const color = document.getElementById('tagColor').value;

        if (!name) {
            alert('Please enter a tag name');
            return;
        }

        try {
            const response = await fetch('/create_tag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, color })
            });

            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message || 'Error creating tag');
            }
        } catch (error) {
            alert('Error creating tag');
            console.error('Error:', error);
        }
    }

    function editTag(tagId, name, color) {
        document.getElementById('editTagId').value = tagId;
        document.getElementById('editTagName').value = name;
        document.getElementById('editTagColor').value = color;
        document.getElementById('editTagColorText').value = color;
        document.getElementById('editTagPreview').textContent = name;
        document.getElementById('editTagPreview').style.backgroundColor = color;
        editTagModal.show();
    }

    async function updateTag() {
        const tagId = document.getElementById('editTagId').value;
        const name = document.getElementById('editTagName').value.trim();
        const color = document.getElementById('editTagColor').value;

        if (!name) {
            alert('Please enter a tag name');
            return;
        }

        try {
            const response = await fetch('/update_tag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tag_id: tagId, name, color })
            });

            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message || 'Error updating tag');
            }
        } catch (error) {
            alert('Error updating tag');
            console.error('Error:', error);
        }
    }

    async function deleteTag(tagId, tagName) {
        if (!confirm(`Are you sure you want to delete the tag "${tagName}"? This will remove it from all books.`)) {
            return;
        }

        try {
            const response = await fetch('/delete_tag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tag_id: tagId })
            });

            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message || 'Error deleting tag');
            }
        } catch (error) {
            alert('Error deleting tag');
            console.error('Error:', error);
        }
    }
</script>

</body>
</html>
